name: Build Test APK

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0). Leave empty to use package.json version'
        required: false
        type: string

jobs:
  build-test-apk:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    environment: GPS
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: setup Java (for Android build only)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: setup Android SDK (for Android build only)
        uses: android-actions/setup-android@v3

      - name: install NDK (for Android build only)
        run: sdkmanager "ndk;27.0.11902837"

      - name: install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - uses: Swatinem/rust-cache@v2
        with:
          key: ubuntu-latest-android-cargo

      - name: get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            # 从 release 事件中获取版本号
            VERSION="${{ github.event.release.tag_name }}"
            # 移除 'v' 前缀（如果存在）
            VERSION=${VERSION#v}
          elif [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            # 移除 'v' 前缀（如果存在）
            VERSION=${VERSION#v}
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "RELEASE_VERSION=v$VERSION" >> $GITHUB_ENV
          echo "Version: $VERSION"

      - name: build Android Release APKs
        env:
          NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/27.0.11902837
        run: |
          # 清理之前的构建
          rm -rf src-tauri/gen/android
          
          # 初始化 Android 项目
          pnpm tauri android init
          
          # 生成图标
          # pnpm tauri icon src-tauri/icons/icon.png
          
          # 恢复 git 状态
          git checkout .

          # 更新版本号（因为 git checkout 会恢复配置文件）
          VERSION="${{ env.PACKAGE_VERSION }}"
          echo "Updating version to $VERSION after git checkout..."
          
          # 更新 tauri.conf.json
          node -e "
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            config.version = '$VERSION';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(config, null, 2) + '\n');
          "
          
          # 更新 Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
          
          echo "Updated version in tauri.conf.json and Cargo.toml to $VERSION"

          # 添加权限到 AndroidManifest.xml
          MANIFEST="src-tauri/gen/android/app/src/main/AndroidManifest.xml"
          PERMISSION_LINE='<uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES"/>'
          grep -q 'REQUEST_INSTALL_PACKAGES' "$MANIFEST" || \
            sed -i "/android.permission.INTERNET/a \    $PERMISSION_LINE" "$MANIFEST"


          # 签名
          pushd src-tauri/gen/android
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" > keystore.properties
          echo "password=${{ secrets.ANDROID_KEY_PASSWORD }}" >> keystore.properties
          base64 -d <<< "${{ secrets.ANDROID_KEY_BASE64 }}" > $RUNNER_TEMP/keystore.jks
          echo "storeFile=$RUNNER_TEMP/keystore.jks" >> keystore.properties

          # 输出一下 secrets.ANDROID_KEY_ALIAS
          echo "ANDROID_KEY_ALIAS: ${ANDROID_KEY_ALIAS}"
          echo "ANDROID_KEY_PASSWORD: ${ANDROID_KEY_PASSWORD}"
          echo "ANDROID_KEY_BASE64: ${ANDROID_KEY_BASE64}"
    

          popd
          version=$PACKAGE_VERSION
          
          # 构建 universal release APK
          pnpm tauri android build
          universal_apk=sensortool_${version}_universal.apk
          cp src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release.apk $universal_apk
          
          # 构建 arm64 release APK
          pnpm tauri android build -t aarch64
          arm64_apk=sensortool_${version}_arm64.apk
          cp src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release.apk $arm64_apk

          echo "Built APK files:"
          ls -la *.apk

      - name: Upload release APKs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apks
          path: ./*.apk
          retention-days: 30

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          name: Release ${{ env.RELEASE_VERSION }}
          body: |
            ## Android Release ${{ env.RELEASE_VERSION }}
            
            ### APK Files
            - **Universal APK**: `sensortool_${{ env.PACKAGE_VERSION }}_universal.apk`
            - **ARM64 APK**: `sensortool_${{ env.PACKAGE_VERSION }}_arm64.apk`
            
            ### Installation
            Download the appropriate APK file for your device architecture and install it.
          files: |
            sensortool_${{ env.PACKAGE_VERSION }}_universal.apk
            sensortool_${{ env.PACKAGE_VERSION }}_arm64.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


